CREATE TABLE [dbo].[People](
	[Id] [uniqueidentifier] NOT NULL,
	[Name] [nvarchar](30) NOT NULL,
	[ValidFrom] [datetime2](7) GENERATED ALWAYS AS ROW START HIDDEN NOT NULL,
	[ValidTo] [datetime2](7) GENERATED ALWAYS AS ROW END HIDDEN NOT NULL,
	[CityId] [uniqueidentifier] NOT NULL,
	[IsEnabled] [bit] NOT NULL,
 CONSTRAINT [PK_People] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
	PERIOD FOR SYSTEM_TIME ([ValidFrom], [ValidTo])
) ON [PRIMARY]
WITH
(
SYSTEM_VERSIONING = ON (HISTORY_TABLE = [dbo].[PeopleHistory])
)
GO

CREATE TABLE [dbo].[PhoneNumbers](
	[Id] [uniqueidentifier] NOT NULL,
	[PersonId] [uniqueidentifier] NOT NULL,
	[Type] [varchar](20) NOT NULL,
	[Number] [varchar](30) NOT NULL,
	[ValidFrom] [datetime2](7) GENERATED ALWAYS AS ROW START HIDDEN NOT NULL,
	[ValidTo] [datetime2](7) GENERATED ALWAYS AS ROW END HIDDEN NOT NULL,
 CONSTRAINT [PK_PhoneNumbers] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
	PERIOD FOR SYSTEM_TIME ([ValidFrom], [ValidTo])
) ON [PRIMARY]
WITH
(
SYSTEM_VERSIONING = ON (HISTORY_TABLE = [dbo].[PhoneNumbersHistory])
)
GO

CREATE TABLE [dbo].[Cities](
	[ID] [uniqueidentifier] NOT NULL,
	[Name] [nvarchar](50) NOT NULL,
	[ValidFrom] [datetime2](7) GENERATED ALWAYS AS ROW START HIDDEN NOT NULL,
	[ValidTo] [datetime2](7) GENERATED ALWAYS AS ROW END HIDDEN NOT NULL,
 CONSTRAINT [PK_Cities] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
	PERIOD FOR SYSTEM_TIME ([ValidFrom], [ValidTo])
) ON [PRIMARY]
WITH
(
SYSTEM_VERSIONING = ON (HISTORY_TABLE = [dbo].[CitiesHistory])
)
GO

INSERT [dbo].[Cities] ([ID], [Name], [ValidFrom], [ValidTo]) VALUES (N'00000000-0000-0000-0000-000000000000', N'(unknown)', CAST(N'1900-01-01T00:00:00.0000000' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2))
GO
INSERT [dbo].[Cities] ([ID], [Name], [ValidFrom], [ValidTo]) VALUES (N'1b5bb889-17d4-4784-ad24-3250b73c8621', N'Duckburg', CAST(N'1900-01-01T00:00:00.0000000' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2))
GO
INSERT [dbo].[Cities] ([ID], [Name], [ValidFrom], [ValidTo]) VALUES (N'd6d641da-f758-4986-9b06-f61bf0da12f6', N'Taggia', CAST(N'1900-01-01T00:00:00.0000000' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2))
GO
INSERT [dbo].[People] ([Id], [Name], [ValidFrom], [ValidTo], [CityId], [IsEnabled]) VALUES (N'eee34f94-f9fe-4d70-8514-bf47a598e408', N'Donald Duck', CAST(N'2023-06-16T13:28:48.5041083' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2), N'1b5bb889-17d4-4784-ad24-3250b73c8621', 1)
GO
INSERT [dbo].[People] ([Id], [Name], [ValidFrom], [ValidTo], [CityId], [IsEnabled]) VALUES (N'54164591-8a76-4749-b626-c43b6fa87987', N'Marco', CAST(N'2023-06-16T13:28:47.5738739' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2), N'd6d641da-f758-4986-9b06-f61bf0da12f6', 1)
GO
INSERT [dbo].[PhoneNumbers] ([Id], [PersonId], [Type], [Number], [ValidFrom], [ValidTo]) VALUES (N'bb38be0a-ac97-4a48-baca-a006a0c0a2ec', N'54164591-8a76-4749-b626-c43b6fa87987', N'Work', N'42000', CAST(N'2023-06-16T13:05:01.9586930' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2))
GO
INSERT [dbo].[PhoneNumbers] ([Id], [PersonId], [Type], [Number], [ValidFrom], [ValidTo]) VALUES (N'9be7942f-47c8-4803-8030-beb66b748d3f', N'54164591-8a76-4749-b626-c43b6fa87987', N'Mobile', N'42', CAST(N'1900-01-01T00:00:00.0000000' AS DateTime2), CAST(N'9999-12-31T23:59:59.9999999' AS DateTime2))
GO
ALTER TABLE [dbo].[Cities] ADD  CONSTRAINT [DF_Cities_ID]  DEFAULT (newid()) FOR [ID]
GO
ALTER TABLE [dbo].[People] ADD  CONSTRAINT [DF_People_Id]  DEFAULT (newid()) FOR [Id]
GO
ALTER TABLE [dbo].[People] ADD  DEFAULT ((1)) FOR [IsEnabled]
GO
ALTER TABLE [dbo].[PhoneNumbers] ADD  CONSTRAINT [DF_PhoneNumbers_Id]  DEFAULT (newid()) FOR [Id]
GO
ALTER TABLE [dbo].[People]  WITH CHECK ADD FOREIGN KEY([CityId])
REFERENCES [dbo].[Cities] ([ID])
GO
ALTER TABLE [dbo].[PhoneNumbers]  WITH CHECK ADD  CONSTRAINT [FK_PhoneNumbers_People] FOREIGN KEY([PersonId])
REFERENCES [dbo].[People] ([Id])
GO
ALTER TABLE [dbo].[PhoneNumbers] CHECK CONSTRAINT [FK_PhoneNumbers_People]
GO

/* 
SET PEOPLE AS TEMPORAL TABLE
*/
ALTER TABLE People
ADD ValidFrom DATETIME2 
GO
 
ALTER TABLE People
ADD ValidTo DATETIME2 
GO

UPDATE People SET ValidFrom = '19000101 00:00:00.0000000', ValidTo = '99991231 23:59:59.9999999'
GO

ALTER TABLE People
ALTER COLUMN ValidFrom DATETIME2 NOT NULL
GO
 
ALTER TABLE People
ALTER COLUMN ValidTo DATETIME2 NOT NULL
GO

ALTER TABLE People
ADD PERIOD FOR SYSTEM_TIME (ValidFrom, ValidTo)

ALTER TABLE People
SET(SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.PeopleHistory, DATA_CONSISTENCY_CHECK = ON))
GO

ALTER TABLE People ALTER COLUMN ValidFrom ADD HIDDEN
GO

ALTER TABLE People ALTER COLUMN ValidTo ADD HIDDEN
GO

/* 
SET PHONENUMBERS AS TEMPORAL TABLE
*/
ALTER TABLE PhoneNumbers
ADD ValidFrom DATETIME2 
GO
 
ALTER TABLE PhoneNumbers
ADD ValidTo DATETIME2 
GO

UPDATE PhoneNumbers SET ValidFrom = '19000101 00:00:00.0000000', ValidTo = '99991231 23:59:59.9999999'
GO

ALTER TABLE PhoneNumbers
ALTER COLUMN ValidFrom DATETIME2 NOT NULL
GO
 
ALTER TABLE PhoneNumbers
ALTER COLUMN ValidTo DATETIME2 NOT NULL
GO

ALTER TABLE PhoneNumbers
ADD PERIOD FOR SYSTEM_TIME (ValidFrom, ValidTo)

ALTER TABLE PhoneNumbers
SET(SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.PhoneNumbersHistory, DATA_CONSISTENCY_CHECK = ON))
GO

ALTER TABLE PhoneNumbers ALTER COLUMN ValidFrom ADD HIDDEN
GO

ALTER TABLE PhoneNumbers ALTER COLUMN ValidTo ADD HIDDEN
GO

/* 
SET CITIES AS TEMPORAL TABLE
*/
ALTER TABLE Cities
ADD ValidFrom DATETIME2 
GO
 
ALTER TABLE Cities
ADD ValidTo DATETIME2 
GO

UPDATE Cities SET ValidFrom = '19000101 00:00:00.0000000', ValidTo = '99991231 23:59:59.9999999'
GO

ALTER TABLE Cities
ALTER COLUMN ValidFrom DATETIME2 NOT NULL
GO
 
ALTER TABLE Cities
ALTER COLUMN ValidTo DATETIME2 NOT NULL
GO

ALTER TABLE Cities
ADD PERIOD FOR SYSTEM_TIME (ValidFrom, ValidTo)

ALTER TABLE Cities
SET(SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.CitiesHistory, DATA_CONSISTENCY_CHECK = ON))
GO

ALTER TABLE Cities ALTER COLUMN ValidFrom ADD HIDDEN
GO

ALTER TABLE Cities ALTER COLUMN ValidTo ADD HIDDEN
GO
